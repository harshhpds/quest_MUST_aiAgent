import os
from typing import List, Dict
from agent.ai_analyzer import AIAnalyzer


class VulnerabilityDetector:
    """
    Coordinates code analysis using AIAnalyzer.
    Responsible for:
    - Reading files
    - Sending code to AI
    - Aggregating vulnerability results
    """

    def __init__(self, ai_analyzer: AIAnalyzer):
        self.ai_analyzer = ai_analyzer

    def analyze_file(self, file_path: str) -> Dict:
        """
        Analyze a single file for vulnerabilities.
        """
        try:
            with open(file_path, "r", encoding="utf-8", errors="ignore") as f:
                code = f.read()
        except Exception:
            return {
                "file": file_path,
                "vulnerabilities": []
            }

        result = self.ai_analyzer.analyze_code(code, file_path)

        # Ensure consistent structure
        if "vulnerabilities" not in result:
            result["vulnerabilities"] = []

        return result

    def analyze_repository(self, root_path: str, file_paths: List[str]) -> List[Dict]:
        """
        Analyze all provided files in the repository.
        """
        all_results = []

        for file_path in file_paths:
            result = self.analyze_file(file_path)
            all_results.append(result)

        return all_results